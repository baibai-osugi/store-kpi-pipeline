name: play-overview-to-bq

on:
  schedule:
    - cron: "30 17 * * *"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Load to staging (replace) from stash (ALL APPS)
        env:
          STASH_BUCKET: ${{ secrets.STASH_BUCKET }}
        run: |
          YYYYMM=$(date -u +"%Y%m")
          gsutil ls "gs://${STASH_BUCKET}/play/installs_*_${YYYYMM}_overview.csv" >/dev/null
          bq --project_id=store-kpi --location=US load \
            --source_format=CSV \
            --skip_leading_rows=1 \
            --replace \
            --schema=Date:DATE,Package_name:STRING,Daily_Device_Installs:INT64,Daily_Device_Uninstalls:INT64,Daily_Device_Upgrades:INT64,Total_User_Installs:INT64,Daily_User_Installs:INT64,Daily_User_Uninstalls:INT64,Active_Device_Installs:INT64,Install_events:INT64,Update_events:INT64,Uninstall_events:INT64 \
            store-kpi:app_kpi_raw.google_play_installs_overview_stage \
            "gs://${STASH_BUCKET}/play/installs_*_${YYYYMM}_overview.csv"

      - name: Merge staging -> daily
        run: |
          bq --project_id=store-kpi --location=US query --nouse_legacy_sql '
          MERGE `store-kpi.app_kpi_raw.google_play_installs_overview_daily` T
          USING `store-kpi.app_kpi_raw.google_play_installs_overview_stage` S
          ON T.Date = S.Date AND T.Package_name = S.Package_name
          WHEN MATCHED THEN UPDATE SET
            Daily_Device_Installs = S.Daily_Device_Installs,
            Daily_Device_Uninstalls = S.Daily_Device_Uninstalls,
            Daily_Device_Upgrades = S.Daily_Device_Upgrades,
            Total_User_Installs = S.Total_User_Installs,
            Daily_User_Installs = S.Daily_User_Installs,
            Daily_User_Uninstalls = S.Daily_User_Uninstalls,
            Active_Device_Installs = S.Active_Device_Installs,
            Install_events = S.Install_events,
            Update_events = S.Update_events,
            Uninstall_events = S.Uninstall_events
          WHEN NOT MATCHED THEN
            INSERT ROW;
          '
