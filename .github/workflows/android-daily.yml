name: android-daily

on:
  schedule:
    - cron: "20 16 * * *"   # JST 01:20
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Install deps
        run: npm install

      - name: Fetch Android latest installs and MERGE
        run: npm run run:android:latest
        env:
          BQ_PROJECT: store-kpi
          BQ_DATASET: app_kpi
          BQ_TABLE_DAILY: downloads_daily
          BQ_LOCATION: asia-northeast1
          GCS_BUCKET: pubsite_prod_rev_02126004667937646089
          GCS_PREFIX: stats/installs/
